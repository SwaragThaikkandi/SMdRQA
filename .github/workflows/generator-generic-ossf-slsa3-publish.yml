# This workflow generates SLSA provenance files for your project.
# The generation satisfies level 3 for the provenance requirements - see https://slsa.dev/spec/v0.1/requirements
# The project is an initiative of the OpenSSF (openssf.org) and is developed at
# https://github.com/slsa-framework/slsa-github-generator.
# The provenance file can be verified using https://github.com/slsa-framework/slsa-verifier.
# For more information about SLSA and how it improves the supply-chain, visit slsa.dev.

name: SLSA Provenance Generator

on:
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      digests: ${{ steps.generate_digest.outputs.digests }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Build artifacts
        run: |
          # Example: Generate artifacts and store them in the 'artifacts' directory
          mkdir artifacts
          echo "artifact1" > artifacts/artifact1
          echo "artifact2" > artifacts/artifact2

      - name: Generate digest
        id: generate_digest
        run: |
          # Generate digests for artifacts and store them in an output
          digests=$(sha256sum artifacts/* | awk '{print $1}' | base64 -w0)
          echo "::set-output name=digests::${digests}"

  generate_provenance:
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      actions: read   # To read the workflow path.
      id-token: write # To sign the provenance.
      contents: write # To add assets to a release.
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Generate SLSA provenance
        uses: slsa-framework/slsa-github-generator@v1.10.0
        with:
          base64-subjects: ${{ needs.build.outputs.digests }}
          upload-assets: true # Optional: Upload to a new release
